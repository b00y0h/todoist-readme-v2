---
phase: 03-git-operations-modernization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [index.js]
autonomous: true

must_haves:
  truths:
    - "Action auto-detects committer name from GitHub actor environment variable"
    - "Action auto-detects committer email from GitHub actor ID in noreply format"
    - "Action uses local git config scope that doesn't leak to other workflow steps"
    - "Action skips commit when no README changes detected"
    - "Action falls back to github-actions bot identity when actor env vars missing"
  artifacts:
    - path: "index.js"
      provides: "Modernized git commit workflow"
      contains: "getActorIdentity"
    - path: "index.js"
      provides: "Local git config scope"
      contains: "--local"
    - path: "index.js"
      provides: "Change detection before commit"
      contains: "diff-index"
  key_links:
    - from: "index.js:commitReadme"
      to: "process.env.GITHUB_ACTOR"
      via: "getActorIdentity function"
      pattern: "GITHUB_ACTOR"
    - from: "index.js:commitReadme"
      to: "git config --local"
      via: "exec call"
      pattern: "--local.*user\\."
---

<objective>
Modernize the git commit workflow to use GitHub Actions context for author identity instead of hardcoded values, use local git config scope to prevent leakage, and add change detection to avoid empty commits.

Purpose: Replace bad practices (hardcoded author, global config, unconditional commits) with modern patterns that work for all action users and respect GitHub Actions isolation.

Output: Refactored commitReadme function with actor detection, local config scope, and smart change detection.
</objective>

<execution_context>
@/home/claude/.claude/get-shit-done/workflows/execute-plan.md
@/home/claude/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-git-operations-modernization/03-RESEARCH.md
@index.js
@exec.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add actor identity detection and local git config</name>
  <files>index.js</files>
  <action>
Create a `getActorIdentity()` function that:
1. Reads `process.env.GITHUB_ACTOR` (username) and `process.env.GITHUB_ACTOR_ID` (numeric ID)
2. If both exist, returns `{ name: actor, email: "${actorId}+${actor}@users.noreply.github.com" }`
3. If missing, falls back to `{ name: "github-actions[bot]", email: "41898282+github-actions[bot]@users.noreply.github.com" }`

Update `commitReadme()` to:
1. Call `getActorIdentity()` to get committer info
2. Change `--global` to `--local` for both git config calls
3. Log the committer identity using `core.info()`
4. Remove hardcoded "Abhishek Naidu" and "example@gmail.com"

The function should be placed near the top of the file with other utility functions (after the TAG_CONFIG definition around line 119).
  </action>
  <verify>
Run `grep -n "getActorIdentity\|--local\|GITHUB_ACTOR" index.js` to confirm:
- getActorIdentity function exists
- --local is used instead of --global
- GITHUB_ACTOR is referenced
  </verify>
  <done>
commitReadme() uses dynamic actor identity from GitHub context with fallback to bot identity, and configures git with local scope.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add change detection before commit</name>
  <files>index.js</files>
  <action>
Create a `hasGitChanges()` async function that:
1. Uses `exec("git", ["diff-index", "--quiet", "HEAD", "--"])` to check for staged changes
2. Returns `false` if command succeeds (exit code 0 = no changes)
3. Returns `true` if command fails with exit code 1 (changes exist)
4. For any other error (e.g., no HEAD in new repo), log a warning and return `true` to allow commit attempt

Update `commitReadme()` to:
1. Stage the file first: `git add README.md`
2. Call `hasGitChanges()` after staging
3. If no changes, log "No changes detected, skipping commit" and return early
4. If changes exist, proceed with git config and commit
5. Update commit message from "Todoist updated." to "ðŸ“Š Update Todoist stats"

Note: The exec.js helper rejects with `err.code` set to the exit code, so `hasGitChanges()` should catch and check `error.code === 1` to differentiate "changes exist" from real errors.
  </action>
  <verify>
Run `grep -n "hasGitChanges\|diff-index\|No changes" index.js` to confirm:
- hasGitChanges function exists
- diff-index command is used
- Skip message exists
  </verify>
  <done>
commitReadme() checks for actual git changes before committing and skips when README content unchanged.
  </done>
</task>

</tasks>

<verification>
1. **Actor detection**: `grep -E "GITHUB_ACTOR|getActorIdentity" index.js` shows identity function
2. **Local scope**: `grep -c "\-\-global" index.js` returns 0, `grep -c "\-\-local" index.js` returns 2
3. **Change detection**: `grep -E "diff-index|hasGitChanges" index.js` shows change detection
4. **Fallback**: `grep "github-actions\[bot\]" index.js` shows bot fallback
5. **No hardcoded values**: `grep -E "Abhishek|example@gmail" index.js` returns nothing
6. **Build succeeds**: `npx @vercel/ncc build index.js -o dist` completes without error
</verification>

<success_criteria>
- [ ] getActorIdentity() returns GitHub actor identity or bot fallback
- [ ] Git config uses --local scope (not --global)
- [ ] hasGitChanges() uses git diff-index to detect changes
- [ ] commitReadme() skips commit when no changes
- [ ] No hardcoded author name/email remains
- [ ] Action builds successfully with ncc
</success_criteria>

<output>
After completion, create `.planning/phases/03-git-operations-modernization/03-01-SUMMARY.md`
</output>
