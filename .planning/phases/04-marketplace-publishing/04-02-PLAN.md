---
phase: 04-marketplace-publishing
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - .github/workflows/release.yml
  - index.js
  - dist/index.js
autonomous: false
user_setup:
  - service: github-marketplace
    why: "Publish action to GitHub Marketplace"
    dashboard_config:
      - task: "Accept GitHub Marketplace Developer Agreement"
        location: "View action.yml in GitHub UI - banner appears prompting agreement"
      - task: "Select marketplace categories when creating release"
        location: "GitHub Releases - 'Publish to GitHub Marketplace' checkbox"

must_haves:
  truths:
    - "Release workflow bundles code with ncc on release publish"
    - "Release workflow updates major version tags (v2) automatically"
    - "index.js sets stats_updated output for workflow consumers"
    - "Action is published to GitHub Marketplace"
    - "v2.0.0 release tag exists with changelog"
  artifacts:
    - path: ".github/workflows/release.yml"
      provides: "Automated release workflow"
      contains: "release:"
    - path: "index.js"
      provides: "Output setting for consumers"
      contains: "setOutput"
  key_links:
    - from: ".github/workflows/release.yml"
      to: "action.yml"
      via: "Bundles and tags for marketplace"
      pattern: "ncc build"
---

<objective>
Create release automation and publish action to GitHub Marketplace.

Purpose: Automated release workflow ensures consistent bundling and major version tags. Marketplace publishing makes the action discoverable to users.

Output: Release workflow, output integration, published marketplace action
</objective>

<execution_context>
@/home/claude/.claude/get-shit-done/workflows/execute-plan.md
@/home/claude/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-marketplace-publishing/04-RESEARCH.md
@.planning/phases/04-marketplace-publishing/04-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add stats_updated output to action</name>
  <files>index.js, dist/index.js</files>
  <action>
Add output setting to index.js so consuming workflows can detect if stats were updated:

1. **Find the updateReadme function** where README changes are detected

2. **Add output before commit logic:**
   After the change detection in commitReadme or updateReadme, add:
   ```javascript
   core.setOutput("stats_updated", "true");
   ```

3. **Add output when no changes:**
   When skipping commit due to no changes, add:
   ```javascript
   core.setOutput("stats_updated", "false");
   ```

4. **Rebuild bundle:**
   ```bash
   npm run build
   ```

**Location hint:** The hasGitChanges() function in commitReadme already detects changes. Set output there:
- If hasChanges is true and commit succeeds: `core.setOutput("stats_updated", "true")`
- If hasChanges is false (skip commit): `core.setOutput("stats_updated", "false")`

This allows workflows to conditionally run steps based on whether stats changed.
  </action>
  <verify>
Verify output integration:
- `grep -q 'setOutput.*stats_updated' index.js`
- `grep -q 'stats_updated.*true' index.js`
- `grep -q 'stats_updated.*false' index.js`
- `npm run build` succeeds
- `grep -q 'setOutput' dist/index.js`
  </verify>
  <done>index.js sets stats_updated output ("true" or "false"), bundle rebuilt</done>
</task>

<task type="auto">
  <name>Task 2: Create release workflow with bundle and tag automation</name>
  <files>.github/workflows/release.yml</files>
  <action>
Create .github/workflows/release.yml for automated release process:

```yaml
name: Release

on:
  release:
    types: [published]

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.release.tag_name }}

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Bundle with ncc
        run: npm run build

      - name: Commit bundled code to release
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Check if dist changed
          git add dist/
          if git diff --staged --quiet; then
            echo "No changes to dist/, skipping commit"
          else
            git commit -m "chore: bundle for ${{ github.event.release.tag_name }}"
            git tag -fa ${{ github.event.release.tag_name }} -m "Release ${{ github.event.release.tag_name }}"
            git push origin ${{ github.event.release.tag_name }} --force
          fi

      - name: Update major version tag
        uses: Actions-R-Us/actions-tagger@v2
        with:
          publish_latest_tag: true
```

**Create directory first:**
```bash
mkdir -p .github/workflows
```

**Key features:**
- Triggers on release publish (not push to tag)
- Checks out the release tag specifically
- Bundles code with ncc (same command as package.json)
- Commits bundled code back to release tag
- Uses actions-tagger to update v2 tag automatically
- Skips commit if dist hasn't changed (idempotent)

**Note:** This workflow runs AFTER the release is created. User creates release with v2.0.0 tag, workflow bundles and updates v2 tag.
  </action>
  <verify>
Verify release workflow:
- `[ -f .github/workflows/release.yml ]`
- `grep -q 'release:' .github/workflows/release.yml`
- `grep -q 'npm run build' .github/workflows/release.yml`
- `grep -q 'actions-tagger' .github/workflows/release.yml`
- `grep -q 'permissions:' .github/workflows/release.yml`
  </verify>
  <done>Release workflow created with bundle, commit, and tag automation</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Publish to GitHub Marketplace</name>
  <what-built>
Documentation (README, CHANGELOG, action.yml) and release workflow are ready.
The action can now be published to GitHub Marketplace.
  </what-built>
  <how-to-verify>
**Pre-publish checklist:**

1. **Verify repository is public** - Marketplace only accepts public repos

2. **Accept Developer Agreement:**
   - Navigate to action.yml in GitHub web UI
   - Look for banner: "Publish this Action to GitHub Marketplace"
   - Click and accept terms if prompted

3. **Create v2.0.0 release:**
   - Go to repository > Releases > "Draft a new release"
   - Tag: `v2.0.0`
   - Title: `v2.0.0 - Major Update`
   - Description: Copy from CHANGELOG.md [2.0.0] section
   - Check "Publish this Action to GitHub Marketplace"
   - Select categories: "Automation", "Utilities" (or similar)
   - Click "Publish release"

4. **Verify release workflow runs:**
   - Go to Actions tab
   - Confirm "Release" workflow triggered
   - Wait for it to complete successfully

5. **Verify marketplace listing:**
   - Search GitHub Marketplace for "todoist readme"
   - Confirm action appears with correct name/description
   - Verify branding icon (activity) and color (red) display

6. **Verify v2 tag exists:**
   ```bash
   git fetch --tags
   git tag -l "v2*"
   ```
   Should show: v2, v2.0, v2.0.0
  </how-to-verify>
  <resume-signal>Type "published" when action is live on GitHub Marketplace, or describe any issues encountered</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Output integration:**
   ```bash
   grep -c "setOutput.*stats_updated" index.js
   # Should be 2 (true and false cases)
   ```

2. **Release workflow:**
   ```bash
   [ -f .github/workflows/release.yml ] && echo "Workflow exists"
   ```

3. **Marketplace publication:**
   - Human verification confirms action appears in marketplace
   - v2 tag exists and points to v2.0.0
</verification>

<success_criteria>
- index.js sets stats_updated output on completion
- dist/index.js bundle updated with output logic
- .github/workflows/release.yml exists with bundle + tag automation
- v2.0.0 release created with changelog
- Action published to GitHub Marketplace
- v2 major version tag points to v2.0.0
- Action discoverable in marketplace search
</success_criteria>

<output>
After completion, create `.planning/phases/04-marketplace-publishing/04-02-SUMMARY.md`
</output>
