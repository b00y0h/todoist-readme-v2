---
phase: 02-stats-retrieval-display
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [index.js, dist/index.js]
autonomous: true

must_haves:
  truths:
    - "User can see current daily streak displayed in README"
    - "User can see longest streak record displayed in README"
    - "Stat formatters are reusable functions for both display modes"
    - "Premium user sees weekly tasks stat; non-premium user does not (STAT-06)"
  artifacts:
    - path: "index.js"
      provides: "Individual stat formatter functions"
      contains: "formatKarmaStat|formatDailyTasksStat|formatCurrentStreakStat|formatWeeklyTasksStat"
    - path: "index.js"
      provides: "Current streak display"
      contains: "current_daily_streak"
    - path: "index.js"
      provides: "Premium-gated weekly stat"
      contains: "isPremium.*formatWeeklyTasksStat|formatWeeklyTasksStat.*isPremium"
  key_links:
    - from: "index.js:updateReadme"
      to: "formatter functions"
      via: "function calls"
      pattern: "format.*Stat\\("
---

<objective>
Add current streak display and refactor stats formatting into reusable functions.

Purpose: Complete missing STAT-04 requirement (current streak) and prepare formatter functions that can be reused by both legacy and granular tag modes in Plan 02.

Output: Working current streak display, individual formatter functions for each stat type.
</objective>

<execution_context>
@/home/claude/.claude/get-shit-done/workflows/execute-plan.md
@/home/claude/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-stats-retrieval-display/02-RESEARCH.md
@index.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract stat formatting into reusable functions</name>
  <files>index.js</files>
  <action>
Refactor the inline stat formatting in updateReadme() into individual reusable functions. Create these formatter functions:

1. `formatKarmaStat(karma)` - Returns formatted karma string or null if undefined
   - Input: karma number
   - Output: "üèÜ  **{formatted}** Karma Points" or null
   - Use Humanize.intComma for formatting

2. `formatDailyTasksStat(days_items)` - Returns formatted daily tasks string or null
   - Input: days_items array from API response
   - Output: "üå∏  Completed **{count}** tasks today" or null
   - Handle zero case (should display "0" not skip)

3. `formatWeeklyTasksStat(week_items, isPremium)` - Returns formatted weekly stats or null
   - Input: week_items array, isPremium boolean
   - Output: "üóì  Completed **{count}** tasks this week" or null
   - Return null if not premium or data unavailable

4. `formatTotalTasksStat(completed_count)` - Returns formatted total or null
   - Input: completed_count number
   - Output: "‚úÖ  Completed **{formatted}** tasks so far" or null
   - Use Humanize.intComma for formatting

5. `formatLongestStreakStat(goals)` - Returns formatted longest streak or null
   - Input: goals object from API response
   - Output: "‚è≥  Longest streak is **{count}** days" or null
   - Access goals?.max_daily_streak?.count

Place formatter functions before updateReadme(). Update updateReadme() to use these functions:

```javascript
const stats = [
  formatKarmaStat(karma),
  formatDailyTasksStat(days_items),
  formatWeeklyTasksStat(week_items, PREMIUM === "true"),
  formatTotalTasksStat(completed_count),
  formatLongestStreakStat(goals)
].filter(Boolean);
```

Key implementation details:
- Use explicit `=== undefined` checks, NOT falsy checks (0 is valid)
- Each function returns null if data unavailable (allows filter(Boolean))
- Keep existing emoji and formatting patterns
- Preserve backward compatibility - output should be identical to current
  </action>
  <verify>
Run `grep -n "function format.*Stat" index.js` to confirm all 5 formatter functions exist.
Run `grep -n "filter(Boolean)" index.js` to confirm stats array pattern.
Run `npm run build` to ensure code compiles.
Verify formatWeeklyTasksStat respects premium flag: `grep -A10 "function formatWeeklyTasksStat" index.js` should show isPremium check.
  </verify>
  <done>
All 5 formatter functions exist (formatKarmaStat, formatDailyTasksStat, formatWeeklyTasksStat, formatTotalTasksStat, formatLongestStreakStat).
formatWeeklyTasksStat returns null for non-premium users and formatted stat for premium users (STAT-06).
updateReadme uses array pattern with filter(Boolean).
Build succeeds with no errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add current daily streak display</name>
  <files>index.js, dist/index.js</files>
  <action>
Add formatCurrentStreakStat function for STAT-04 requirement (current streak display):

```javascript
function formatCurrentStreakStat(goals) {
  const count = goals?.current_daily_streak?.count;

  if (count === undefined) return null;

  if (count === 0) {
    return `üî•  Current streak: **0 days** - Start one today!`;
  }

  const days = count === 1 ? 'day' : 'days';
  return `üî•  Current streak: **${count} ${days}**`;
}
```

Add to stats array in updateReadme, positioned BEFORE longest streak (logical ordering: current then longest):

```javascript
const stats = [
  formatKarmaStat(karma),
  formatDailyTasksStat(days_items),
  formatWeeklyTasksStat(week_items, PREMIUM === "true"),
  formatTotalTasksStat(completed_count),
  formatCurrentStreakStat(goals),   // NEW: Current streak
  formatLongestStreakStat(goals)
].filter(Boolean);
```

Key implementation details:
- Handle zero streak with encouraging message
- Pluralize "day/days" correctly
- Use fire emoji to differentiate from longest streak (hourglass)

After adding, rebuild the bundle:
```bash
npm run build
```
  </action>
  <verify>
Run `grep -n "formatCurrentStreakStat" index.js` to confirm function exists.
Run `grep -n "current_daily_streak" index.js` to confirm API field access.
Run `npm run build` to verify build succeeds.
Check `ls -la dist/index.js` to confirm bundle was rebuilt.
  </verify>
  <done>
formatCurrentStreakStat function exists and handles zero/non-zero cases.
Current streak appears in stats array before longest streak.
npm build succeeds and dist/index.js is updated.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Formatter functions exist:**
   ```bash
   grep -c "function format.*Stat" index.js
   # Expected: 6 (karma, daily, weekly, total, current streak, longest streak)
   ```

2. **Stats array uses formatters:**
   ```bash
   grep -A10 "const stats = \[" index.js
   # Should show all 6 formatter calls
   ```

3. **Current streak implementation:**
   ```bash
   grep -n "current_daily_streak" index.js
   # Should find access in formatCurrentStreakStat function
   ```

4. **Bundle builds:**
   ```bash
   npm run build && echo "Build successful"
   ```
</verification>

<success_criteria>
- 6 stat formatter functions extracted and working
- Current streak (STAT-04) displays with encouraging zero-day message
- Weekly tasks (STAT-06) displays for premium users only (isPremium check in formatWeeklyTasksStat)
- Legacy behavior unchanged (backward compatible)
- Build succeeds
- Ready for Plan 02 to add granular tag support using these formatters
</success_criteria>

<output>
After completion, create `.planning/phases/02-stats-retrieval-display/02-01-SUMMARY.md`
</output>
