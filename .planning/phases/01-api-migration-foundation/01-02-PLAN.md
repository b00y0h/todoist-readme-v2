---
phase: 01-api-migration-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - index.js
  - dist/index.js
autonomous: true

must_haves:
  truths:
    - "Action connects to Todoist API v1 endpoint"
    - "Action retrieves stats from sync response"
    - "Action displays clear error on API failure"
    - "Action retries on rate limit (429)"
    - "Action fails fast on auth error (401)"
  artifacts:
    - path: "index.js"
      provides: "API v1 integration with error handling"
      contains: "api.todoist.com/api/v1"
    - path: "dist/index.js"
      provides: "Bundled action with new API"
      min_lines: 100
  key_links:
    - from: "index.js"
      to: "https://api.todoist.com/api/v1/sync"
      via: "axios.post"
      pattern: "api/v1/sync"
    - from: "index.js"
      to: "axios-retry"
      via: "require/import"
      pattern: "axios-retry"
---

<objective>
Migrate from deprecated Todoist Sync API v9 to unified API v1 with comprehensive error handling and rate limit retry logic.

Purpose: The v9 API was shut down on Feb 10, 2026. This migration restores functionality using the new v1 endpoint.
Output: Action connects to API v1, retrieves stats, handles errors gracefully, respects rate limits.
</objective>

<execution_context>
@/home/claude/.claude/get-shit-done/workflows/execute-plan.md
@/home/claude/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-api-migration-foundation/01-RESEARCH.md
@.planning/phases/01-api-migration-foundation/01-01-SUMMARY.md

@index.js
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate API call from v9 to v1 sync endpoint</name>
  <files>index.js</files>
  <action>
    Modify the main() function in index.js to use the v1 API:

    **OLD CODE (line 12-15):**
    ```javascript
    const stats = await axios(
      "https://api.todoist.com/sync/v9/completed/get_stats",
      { headers: { Authorization: `Bearer ${TODOIST_API_KEY}` } }
    );
    await updateReadme(stats.data);
    ```

    **NEW CODE:**
    ```javascript
    const response = await axios.post(
      "https://api.todoist.com/api/v1/sync",
      {
        sync_token: "*",
        resource_types: '["all"]'
      },
      {
        headers: {
          Authorization: `Bearer ${TODOIST_API_KEY}`,
          "Content-Type": "application/json"
        },
        timeout: 10000
      }
    );

    // V1 API nests stats in response object
    const stats = response.data.stats;
    if (!stats) {
      core.error("Stats not found in API response. Available keys: " + Object.keys(response.data).join(", "));
      core.setFailed("Todoist API did not return stats data");
      return;
    }

    await updateReadme(stats);
    ```

    **Critical changes:**
    1. GET -> POST request method
    2. URL: /sync/v9/completed/get_stats -> /api/v1/sync
    3. Add request body with sync_token and resource_types
    4. Add timeout (10 seconds)
    5. Extract stats from response.data.stats (not response.data directly)
    6. Add validation that stats exists in response

    The updateReadme function expects the same shape (karma, completed_count, days_items, goals, week_items), so no changes needed there IF v1 preserves the same structure. Research indicates it should.
  </action>
  <verify>Grep index.js for "api.todoist.com/api/v1/sync" and "response.data.stats"</verify>
  <done>API call migrated to v1 endpoint with stats extraction from sync response</done>
</task>

<task type="auto">
  <name>Task 2: Add comprehensive error handling for API failures</name>
  <files>index.js</files>
  <action>
    Wrap the API call in try-catch with specific error handling:

    **Add to main() function:**
    ```javascript
    async function main() {
      try {
        // ... existing API call code ...
      } catch (error) {
        handleApiError(error);
      }
    }

    function handleApiError(error) {
      if (error.response) {
        // Server responded with error status
        const status = error.response.status;
        const message = error.response.data?.message || error.message;

        if (status === 401) {
          core.setFailed("Authentication failed. Check your TODOIST_API_KEY is valid.");
        } else if (status === 403) {
          core.setFailed("Access forbidden. Your API key may lack required permissions.");
        } else if (status === 404) {
          core.setFailed("Stats endpoint not found. Todoist API may have changed.");
        } else if (status === 429) {
          // Rate limit - this should be handled by axios-retry, but if we get here:
          core.setFailed("Rate limited by Todoist API. Try again later.");
        } else if (status >= 500) {
          core.setFailed(`Todoist server error (${status}). Try again later.`);
        } else {
          core.setFailed(`Todoist API error (${status}): ${message}`);
        }
      } else if (error.code === "ECONNABORTED") {
        core.setFailed("Request timed out. Todoist API may be slow or unreachable.");
      } else if (error.request) {
        // Request made but no response received
        core.setFailed("No response from Todoist API. Check network connectivity.");
      } else {
        // Error setting up request
        core.setFailed(`Failed to call Todoist API: ${error.message}`);
      }
    }
    ```

    This provides clear, actionable error messages for all failure modes:
    - API-01: Verifies stats endpoint availability (404 handling)
    - API-03: Handles API errors gracefully with clear error messages
  </action>
  <verify>Grep index.js for "handleApiError" and "core.setFailed"</verify>
  <done>Error handling added for auth (401), forbidden (403), not found (404), rate limit (429), server errors (5xx), timeout, and network errors</done>
</task>

<task type="auto">
  <name>Task 3: Add rate limit retry with exponential backoff</name>
  <files>index.js, dist/index.js</files>
  <action>
    Add axios-retry configuration at the top of index.js (after requires):

    **Add after existing requires (around line 5):**
    ```javascript
    const axiosRetry = require("axios-retry").default;

    // Configure retry behavior for rate limits and transient errors
    axiosRetry(axios, {
      retries: 3,
      retryDelay: (retryCount, error) => {
        // Respect Retry-After header if present
        const retryAfter = error.response?.headers?.["retry-after"];
        if (retryAfter) {
          core.info(`Rate limited. Waiting ${retryAfter}s as requested by Todoist.`);
          return parseInt(retryAfter, 10) * 1000;
        }
        // Exponential backoff: 1s, 2s, 4s
        const delay = Math.pow(2, retryCount - 1) * 1000;
        core.info(`Retrying in ${delay / 1000}s (attempt ${retryCount}/3)`);
        return delay;
      },
      retryCondition: (error) => {
        // Retry on rate limit (429) and server errors (5xx)
        const status = error.response?.status;
        return (
          axiosRetry.isNetworkError(error) ||
          status === 429 ||
          (status >= 500 && status < 600)
        );
      },
      onRetry: (retryCount, error, requestConfig) => {
        core.warning(`Todoist API request failed, retrying (attempt ${retryCount}): ${error.message}`);
      }
    });
    ```

    This satisfies API-04: Action respects rate limits (no silent failures):
    - Automatically retries on 429 with Retry-After header support
    - Uses exponential backoff (1s, 2s, 4s) when no Retry-After provided
    - Logs warnings so user knows retries are happening
    - Retries on 5xx server errors too (transient failures)
    - Does NOT retry on 401/403/404 (permanent failures)

    **After adding retry logic, rebuild the bundle:**
    `npm run build`
  </action>
  <verify>Grep index.js for "axios-retry" and "retryCondition", run `npm run build` successfully</verify>
  <done>Rate limit retry configured with exponential backoff and Retry-After header support, bundle rebuilt</done>
</task>

</tasks>

<verification>
- [ ] index.js contains API v1 URL: "api.todoist.com/api/v1/sync"
- [ ] index.js uses POST method with request body
- [ ] index.js extracts stats from response.data.stats
- [ ] index.js has handleApiError function
- [ ] index.js has axios-retry configured with 3 retries
- [ ] index.js retry logic checks for 429 and 5xx status codes
- [ ] `npm run build` completes without errors
- [ ] dist/index.js has recent modification time
</verification>

<success_criteria>
Action migrated to Todoist API v1. Error handling provides clear messages for all failure modes. Rate limiting handled with exponential backoff. Requirements API-01, API-02, API-03, API-04 addressed.
</success_criteria>

<output>
After completion, create `.planning/phases/01-api-migration-foundation/01-02-SUMMARY.md`
</output>
